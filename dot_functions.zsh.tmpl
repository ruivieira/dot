GREEN="\033[1;32m"
YELLOW="\033[1;93m"
NOCOLOR="\033[0m"

function pyenvcreate () {
	local PROJ_DIR=$(basename $(pwd))
	echo creating pyenv: $fg[green]$PROJ_DIR $reset_color
	pyenv virtualenv 3.8.5 $PROJ_DIR
}

function pyenvactivate () {
	local PROJ_DIR=$(basename $(pwd))
	echo activating pyenv: $fg[green]$PROJ_DIR $reset_color
	pyenv activate $PROJ_DIR
}

function pyenvdelete () {
	local PROJ_DIR=$(basename $(pwd))
	echo deleting pyenv: $fg[green]$PROJ_DIR $reset_color
	pyenv virtualenv-delete $PROJ_DIR
}

{{- if eq .chezmoi.os "darwin" }}
function jvm_exists() {
	/usr/libexec/java_home -v$1 >& /dev/null
	if [ $? -eq 0 ]; then
		return 0
	else
		return 1
	fi
}
{{- end }}

function prepare_backup() {
	cd ~/Sync/
	echo -e "${GREEN}Sync code folders${NOCOLOR}"
	rsync -avh --exclude-from='.stignore' --delete  ~/Sync/code ~/Dropbox/code/backup/

    echo -e "${GREEN}Sync notes folders${NOCOLOR}"
	rsync -avh --exclude-from='.stignore' --delete  ~/Sync/notes ~/Dropbox/notes/

    echo -e "${GREEN}Sync epubs folder${NOCOLOR}"
	rsync -avh --exclude-from='.stignore' --delete  ~/Sync/documents/books/epubs/ ~/Dropbox/Documents/Books/eBooks/
}

function docker_nuke() {
	# Delete all containers
	docker rm $(docker ps -a -q)
	# Delete all images
	docker rmi $(docker images -q)
}

function borg_backup_code() {
	local archive_name="$(date +%s)"
	borg create --progress --stats --compression zlib ~/Backup::code-${archive_name} ~/Dropbox/code/backup/code
}

function b2_upload_backup() {
	rclone -P sync ~/Backup b2:$B2_BACKUP_BUCKET
}

function kopia_b2_connect() {
	local BUCKET='{{ keepassxcAttribute "B2" "kopia_bucket" }}'
	echo -e "${GREEN}[kopia]${NOCOLOR} connecting to repository ${YELLOW}B2:$BUCKET${NOCOLOR}"
	kopia repository connect b2 \
		--bucket=$BUCKET \
		--key-id='{{ keepassxcAttribute "B2" "kopia_key_id" }}' \
		--key='{{ keepassxcAttribute "B2" "kopia_application_key" }}' \
		--password='{{ (keepassxc "Kopia").Password }}'
}

function kopia_local_connect() {
	echo -e "${GREEN}[kopia]${NOCOLOR} connecting to ${YELLOW}local volume${NOCOLOR}"
	kopia repository connect filesystem --path=/Volumes/Backup \
		--password='{{ (keepassxc "Kopia").Password }}'
}

function kopia_backup() {
	local CURRENT_REPO=$(kopia repository status | awk 'NR==3' | cut -c 36-)

    echo -e "${GREEN}[kopia]${NOCOLOR} Backing up code to ${YELLOW}$CURRENT_REPO${NOCOLOR}"
	kopia snapshot create ~/Dropbox/code/backup/code

    echo -e "${GREEN}[kopia]${NOCOLOR} Backing up docs to ${YELLOW}$CURRENT_REPO${NOCOLOR}"
	kopia snapshot create ~/Sync/documents

    echo -e "${GREEN}[kopia]${NOCOLOR} Backing up sites to ${YELLOW}$CURRENT_REPO${NOCOLOR}"
	kopia snapshot create ~/Sync/sites

    echo -e "${GREEN}[kopia]${NOCOLOR} Backing up notes to ${YELLOW}$CURRENT_REPO${NOCOLOR}"
	kopia snapshot create ~/Sync/notes
}

function rsync_net_backup() {
	cd ~/Sync/
	local LOG_FILE="/Users/$USER/tmp/rsyncnet.log"
	touch $LOG_FILE
	echo BEGIN `date` >> ${LOG_FILE}
	echo -e "${GREEN}Sync code folders${NOCOLOR}"
	rsync -avH --exclude-from='.stignore' ~/Sync/code rsyncnet: >> ${LOG_FILE}
	echo -e "${GREEN}Sync journal folder${NOCOLOR}"
	rsync -avH --exclude-from='.stignore' ~/Library/Containers/co.noteplan.NotePlan3/Data/Library/Application\ Support/co.noteplan.NotePlan3/ rsyncnet:wiki >> ${LOG_FILE}
	echo END `date` >> ${LOG_FILE}
}

function rclone_b2_backup() {
	cd ~/Sync/
	echo -e "${GREEN}[rclone]${NOCOLOR} Backing up code to ${YELLOW}B2:{{ keepassxcAttribute "B2" "rclone_bucket_name" }}${NOCOLOR}"
	rclone sync --fast-list -v --exclude-from='.stignore' ~/Sync/code B2:{{ keepassxcAttribute "B2" "rclone_bucket_name" }}/code
}

function rclone_wasabi_backup() {
	cd ~/Sync/
	echo -e "${GREEN}[rclone]${NOCOLOR} Backing up code to ${YELLOW}Wasabi:{{ keepassxcAttribute "Wasabi" "code_bucket_name" }}${NOCOLOR}"
	rclone sync --fast-list -v --exclude-from='.stignore' ~/Sync/code wasabi:{{ keepassxcAttribute "Wasabi" "code_bucket_name" }}
}

function knitmd {
	Rscript -e "library(knitr); knit('$1')"
}

function syncthing_conflicts {
	find $1 -name "*.sync-conflict*"
}

function syncthing_conflicts_delete {
	find "$1" -name "*.sync-conflict*" -delete
}
